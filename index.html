<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Bank Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">
    <style>
        .section { display: none; }
        .section.active { display: block; }
        body { font-family: 'Arial', sans-serif; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        textarea { min-height: 100px; }
        .multiselect {
            position: relative;
            width: 100%;
        }
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .multiselect-option {
            padding: 8px 12px;
            cursor: pointer;
        }
        .multiselect-option:hover {
            background-color: #f0f0f0;
        }
        .multiselect-option.selected {
            background-color: #e0e7ff;
        }
        .multiselect-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 4px;
        }
        .multiselect-tag {
            background-color: #e0e7ff;
            padding: 2px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 0.75rem;
        }
        .multiselect-tag button {
            margin-left: 4px;
            font-size: 0.75rem;
            background: none;
            border: none;
            color: #4f46e5;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="bg-blue-700 text-white p-4 rounded-t-lg shadow-md">
            <h1 class="text-3xl font-bold text-center">Question Bank Generator</h1>
            <p class="text-center mt-2">Generate high-quality, customized questions using AI based on your syllabus and course outcomes</p>
        </header>
        <!-- Navigation -->
        <div class="bg-gray-200 p-4 flex justify-between items-center flex-wrap">
            <nav class="flex space-x-1 flex-wrap">
                <button id="nav-course" class="nav-btn bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 transition mb-1 sm:mb-0">1. Course Details</button>
                <button id="nav-api" class="nav-btn bg-gray-400 text-white px-3 py-2 rounded hover:bg-blue-600 transition mb-1 sm:mb-0">2. API Key</button>
                <button id="nav-syllabus" class="nav-btn bg-gray-400 text-white px-3 py-2 rounded hover:bg-blue-600 transition mb-1 sm:mb-0">3. Syllabus & Outcomes</button>
                <button id="nav-mapping" class="nav-btn bg-gray-400 text-white px-3 py-2 rounded hover:bg-blue-600 transition mb-1 sm:mb-0">4. Question Mapping</button>
                <button id="nav-distribution" class="nav-btn bg-gray-400 text-white px-3 py-2 rounded hover:bg-blue-600 transition mb-1 sm:mb-0">5. Question Distribution</button>
                <button id="nav-generated" class="nav-btn bg-gray-400 text-white px-3 py-2 rounded hover:bg-blue-600 transition mb-1 sm:mb-0">6. Generated Questions</button>
            </nav>
            <div class="flex space-x-2 mt-2 sm:mt-0">
                <button id="save-btn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
                <button id="load-btn" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700 transition">
                    <i class="fas fa-folder-open mr-1"></i> Load
                </button>
            </div>
        </div>
        <!-- Alerts -->
        <div id="alert-container" class="my-4 hidden">
            <div id="alert" class="p-4 rounded"></div>
        </div>
        <!-- Content Sections -->
        <div class="bg-white p-6 rounded-b-lg shadow-md">
            <!-- 1. Course Details -->
            <section id="course-details" class="section active">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Course Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="courseCode" class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                        <input type="text" id="courseCode" class="w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">
                    </div>
                    <div>
                        <label for="courseTitle" class="block text-sm font-medium text-gray-700 mb-1">Course Title</label>
                        <input type="text" id="courseTitle" class="w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">
                    </div>
                    <div>
                        <label for="credits" class="block text-sm font-medium text-gray-700 mb-1">Credits</label>
                        <input type="number" id="credits" min="1" max="10" class="w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <input type="text" id="department" class="w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="courseDescription" class="block text-sm font-medium text-gray-700 mb-1">Course Description</label>
                    <textarea id="courseDescription" class="w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none"></textarea>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="course-next" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Next <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </section>
            <!-- 2. API Key Validation -->
            <section id="api-key" class="section">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">API Key Validation</h2>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                Your Google Gemini 1.5 Pro API key is required for AI-powered question generation.
                                <a href="https://ai.google.dev/gemini-api" target="_blank" class="font-medium underline hover:text-yellow-600">
                                    Get your API key here
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Google Gemini 1.5 Pro API Key</label>
                    <div class="flex">
                        <input type="password" id="apiKey" class="flex-grow p-2 border rounded-l focus:ring focus:ring-blue-300 focus:outline-none" placeholder="Enter your API key">
                        <button id="toggleApiView" class="bg-gray-300 px-3 border-t border-r border-b rounded-r">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="validateApi" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-check-circle mr-1"></i> Validate API Key
                    </button>
                    <div id="apiStatus" class="mt-2"></div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="api-prev" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-chevron-left mr-1"></i> Previous</button>
                    <button id="api-next" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition" disabled>Next <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </section>
            <!-- 3. Syllabus and Course Outcomes -->
            <section id="syllabus-outcomes" class="section">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Syllabus and Course Outcomes</h2>
                <div class="mb-8">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Syllabus Units</h3>
                    <div id="units-container">
                        <div class="unit-entry bg-gray-50 p-4 rounded mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-medium">Unit 1</h4>
                                <button class="remove-unit text-red-600 hover:text-red-800" data-index="0">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Unit Title</label>
                                <input type="text" class="unit-title w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Topics (one per line)</label>
                                <textarea class="unit-topics w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none"></textarea>
                            </div>
                        </div>
                    </div>
                    <button id="add-unit" class="mt-2 bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">
                        <i class="fas fa-plus mr-1"></i> Add Another Unit
                    </button>
                </div>
                <div class="mb-6">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Course Outcomes</h3>
                    <p class="text-gray-600 mb-4">Define the expected outcomes that students should achieve after completing this course</p>
                    <div id="outcomes-container">
                        <div class="outcome-entry bg-gray-50 p-4 rounded mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-medium">Course Outcome 1 (CO1)</h4>
                                <button class="remove-outcome text-red-600 hover:text-red-800" data-index="0">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea class="outcome-description w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none"></textarea>
                            </div>
                        </div>
                    </div>
                    <button id="add-outcome" class="mt-2 bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">
                        <i class="fas fa-plus mr-1"></i> Add Another Outcome
                    </button>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="syllabus-prev" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-chevron-left mr-1"></i> Previous</button>
                    <button id="syllabus-next" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Next <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </section>
            <!-- 4. Question Mapping -->
            <section id="question-mapping" class="section">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Question Mapping</h2>
                <div class="mb-6">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Import Question Mapping</h3>
                    <p class="text-gray-600 mb-4">Paste your question mapping table. Supported formats: CSV or tab-delimited text with columns for Unit, Question Type, Question No, Marks, Bloom Level, and Course Outcome.</p>
                    <textarea id="mapping-import" class="w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none min-h-[150px]" placeholder="Paste CSV or tab-delimited data here..."></textarea>
                    <button id="parse-mapping" class="mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-file-import mr-1"></i> Parse Mapping
                    </button>
                </div>
                <div class="mb-6">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Mapping Preview</h3>
                    <div class="overflow-x-auto">
                        <table id="mapping-table" class="min-w-full bg-white border">
                            <thead>
                                <tr>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unit</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Question Type</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Question No</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Marks</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Bloom Level</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Course Outcome</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-table-body">
                                <!-- Table rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="add-mapping-row" class="mt-3 bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">
                        <i class="fas fa-plus mr-1"></i> Add Row
                    </button>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="mapping-prev" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-chevron-left mr-1"></i> Previous</button>
                    <button id="mapping-next" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Next <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </section>
            <!-- 5. Question Distribution -->
            <section id="question-distribution" class="section">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Question Distribution</h2>
                <div class="mb-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead>
                                <tr>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unit</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Question Type</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Number of Questions</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Marks</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Bloom Level</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Course Outcome</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Difficulty</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="distribution-table-body">
                                <!-- Distribution entries will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="add-distribution-row" class="mt-3 bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">
                        <i class="fas fa-plus mr-1"></i> Add Distribution Entry
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 bg-gray-50 p-4 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Total Marks: <span id="total-marks">0</span></p>
                        <p class="text-sm font-medium text-gray-700 mt-1">Total Questions: <span id="total-questions">0</span></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">MCQ Percentage: <span id="mcq-percentage">0%</span></p>
                        <p class="text-sm font-medium text-gray-700 mt-1">Short Answer Percentage: <span id="short-percentage">0%</span></p>
                        <p class="text-sm font-medium text-gray-700 mt-1">Long Answer Percentage: <span id="long-percentage">0%</span></p>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Unit Distribution</h3>
                    <div id="unit-distribution-chart" class="h-16 bg-gray-100 rounded p-2 flex items-center">
                        <!-- Unit distribution bars will be inserted here -->
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Automatic Distribution Preview</h3>
                    <button id="generate-distribution" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition mb-4">
                        <i class="fas fa-magic mr-1"></i> Auto-Generate Distribution
                    </button>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead>
                                <tr>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unit</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Question Type</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Number of Questions</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Marks</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Bloom Level</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Course Outcome</th>
                                    <th class="py-2 px-3 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Difficulty</th>
                                </tr>
                            </thead>
                            <tbody id="auto-distribution-body">
                                <!-- Auto-generated distribution will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="distribution-prev" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-chevron-left mr-1"></i> Previous</button>
                    <button id="distribution-next" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Next <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </section>
            <!-- 6. Generated Questions -->
            <section id="generated-questions" class="section">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Generated Questions</h2>
                <div id="generation-controls" class="mb-6">
                    <button id="generate-questions" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-robot mr-1"></i> Generate Questions
                    </button>
                    <div id="generation-status" class="mt-4 hidden">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-700 mr-3"></div>
                            <span class="text-blue-700">Generating questions... This may take a minute.</span>
                        </div>
                    </div>
                </div>
                <div id="question-filters" class="mb-6 flex flex-wrap items-center gap-2 p-4 bg-gray-50 rounded">
                    <span class="text-gray-700 font-medium">Filter:</span>
                    <select id="filter-unit" class="p-2 border rounded">
                        <option value="all">All Units</option>
                    </select>
                    <select id="filter-type" class="p-2 border rounded">
                        <option value="all">All Types</option>
                        <option value="MCQ">MCQ</option>
                        <option value="Short Answer">Short Answer</option>
                        <option value="Long Answer">Long Answer</option>
                    </select>
                    <select id="filter-bloom" class="p-2 border rounded">
                        <option value="all">All Bloom Levels</option>
                        <option value="Remember">Remember</option>
                        <option value="Understand">Understand</option>
                        <option value="Apply">Apply</option>
                        <option value="Analyze">Analyze</option>
                        <option value="Evaluate">Evaluate</option>
                        <option value="Create">Create</option>
                    </select>
                    <select id="filter-co" class="p-2 border rounded">
                        <option value="all">All Course Outcomes</option>
                    </select>
                </div>
                <div id="questions-container">
                    <!-- Generated questions will be displayed here -->
                    <div class="text-gray-500 text-center py-10">
                        <i class="fas fa-lightbulb text-4xl mb-4 text-yellow-500"></i>
                        <p>Questions will appear here after generation.</p>
                        <p class="text-sm mt-2">Make sure you have filled in all the required information in previous sections.</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="questions-prev" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-chevron-left mr-1"></i> Previous</button>
                    <div class="flex gap-2">
                        <button id="export-questions-html" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                            <i class="fas fa-file-export mr-1"></i> Export HTML
                        </button>
                        <button id="export-questions-word" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
                            <i class="fas fa-file-word mr-1"></i> Export Word
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation
            const navButtons = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.section');

            // Helper functions
            function showSection(sectionId) {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                updateNavButtons(sectionId);
            }

            function updateNavButtons(activeSection) {
                navButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-gray-400');
                });
                const activeButton = document.getElementById('nav-' + activeSection.split('-')[0]);
                if (activeButton) {
                    activeButton.classList.remove('bg-gray-400');
                    activeButton.classList.add('bg-blue-600');
                }
            }

            // Initialize navigation button clicks
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.id.replace('nav-', '') + (
                        this.id === 'nav-course' ? '-details' : 
                        this.id === 'nav-api' ? '-key' : 
                        this.id === 'nav-syllabus' ? '-outcomes' : 
                        this.id === 'nav-mapping' ? '-mapping' : 
                        this.id === 'nav-distribution' ? '-distribution' : 
                        '-questions'
                    );
                    showSection(sectionId);
                });
            });

            // Next/Previous buttons
            document.getElementById('course-next').addEventListener('click', () => showSection('api-key'));
            document.getElementById('api-prev').addEventListener('click', () => showSection('course-details'));
            document.getElementById('api-next').addEventListener('click', () => showSection('syllabus-outcomes'));
            document.getElementById('syllabus-prev').addEventListener('click', () => showSection('api-key'));
            document.getElementById('syllabus-next').addEventListener('click', () => showSection('question-mapping'));
            document.getElementById('mapping-prev').addEventListener('click', () => showSection('syllabus-outcomes'));
            document.getElementById('mapping-next').addEventListener('click', () => showSection('question-distribution'));
            document.getElementById('distribution-prev').addEventListener('click', () => showSection('question-mapping'));
            document.getElementById('distribution-next').addEventListener('click', () => showSection('generated-questions'));
            document.getElementById('questions-prev').addEventListener('click', () => showSection('question-distribution'));

            // Show/Hide API Key
            document.getElementById('toggleApiView').addEventListener('click', function() {
                const apiKeyInput = document.getElementById('apiKey');
                const eyeIcon = this.querySelector('i');
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    eyeIcon.classList.remove('fa-eye');
                    eyeIcon.classList.add('fa-eye-slash');
                } else {
                    apiKeyInput.type = 'password';
                    eyeIcon.classList.remove('fa-eye-slash');
                    eyeIcon.classList.add('fa-eye');
                }
            });

            // API Key Validation
            document.getElementById('validateApi').addEventListener('click', validateApiKey);
            
            async function validateApiKey() {
                const apiKey = document.getElementById('apiKey').value;
                const apiStatusDiv = document.getElementById('apiStatus');
                const apiNextBtn = document.getElementById('api-next');
                
                if (!apiKey) {
                    showAlert('Please enter an API key', 'error');
                    return;
                }
                
                apiStatusDiv.innerHTML = `
                <div class="flex items-center text-blue-600">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                    <span>Validating API key...</span>
                </div>`;
                
                try {
                    // Test the API key with a simple call to Gemini API
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: "Test API connection. Respond with only 'OK' to confirm"
                                }]
                            }],
                            generationConfig: {
                                maxOutputTokens: 10
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        apiStatusDiv.innerHTML = `
                        <div class="text-red-600">
                            <i class="fas fa-times-circle mr-2"></i>
                            <span>API key validation failed: ${data.error.message || 'Invalid API key'}</span>
                        </div>`;
                        apiNextBtn.disabled = true;
                    } else {
                        apiStatusDiv.innerHTML = `
                        <div class="text-green-600">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>API key validated successfully!</span>
                        </div>`;
                        apiNextBtn.disabled = false;
                        // Save the API key to local storage
                        localStorage.setItem('geminiApiKey', apiKey);
                        showAlert('API key validated and saved', 'success');
                    }
                } catch (error) {
                    apiStatusDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-times-circle mr-2"></i>
                        <span>Error validating API key: ${error.message}</span>
                    </div>`;
                    apiNextBtn.disabled = true;
                }
            }

            // Check for saved API key on page load
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                document.getElementById('apiStatus').innerHTML = `
                <div class="text-gray-600">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>API key loaded from storage. Please validate to proceed.</span>
                </div>`;
            }

            // Syllabus Units
            let unitCounter = 1;
            
            document.getElementById('add-unit').addEventListener('click', function() {
                unitCounter++;
                addUnitEntry(unitCounter);
            });
            
            function addUnitEntry(unitNumber) {
                const unitTemplate = `
                <div class="unit-entry bg-gray-50 p-4 rounded mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-medium">Unit ${unitNumber}</h4>
                        <button class="remove-unit text-red-600 hover:text-red-800" data-index="${unitNumber - 1}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Title</label>
                        <input type="text" class="unit-title w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Topics (one per line)</label>
                        <textarea class="unit-topics w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none"></textarea>
                    </div>
                </div>
                `;
                
                const unitsContainer = document.getElementById('units-container');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = unitTemplate;
                const unitElement = tempDiv.firstElementChild;
                unitsContainer.appendChild(unitElement);
                
                // Attach remove event to the new button
                unitElement.querySelector('.remove-unit').addEventListener('click', function() {
                    if (document.querySelectorAll('.unit-entry').length > 1) {
                        this.closest('.unit-entry').remove();
                        reindexUnits();
                    } else {
                        showAlert('You must have at least one unit', 'warning');
                    }
                });
            }

            // Attach event listener to initial remove unit button
            document.querySelector('.remove-unit').addEventListener('click', function() {
                if (document.querySelectorAll('.unit-entry').length > 1) {
                    this.closest('.unit-entry').remove();
                    reindexUnits();
                } else {
                    showAlert('You must have at least one unit', 'warning');
                }
            });
            
            function reindexUnits() {
                const units = document.querySelectorAll('.unit-entry');
                units.forEach((unit, index) => {
                    const heading = unit.querySelector('h4');
                    heading.textContent = `Unit ${index + 1}`;
                    unit.querySelector('.remove-unit').dataset.index = index;
                });
                unitCounter = units.length;
                // Update unit filters
                updateUnitFilters();
            }

            // Course Outcomes
            let outcomeCounter = 1;
            
            document.getElementById('add-outcome').addEventListener('click', function() {
                outcomeCounter++;
                addOutcomeEntry(outcomeCounter);
            });
            
            function addOutcomeEntry(outcomeNumber) {
                const outcomeTemplate = `
                <div class="outcome-entry bg-gray-50 p-4 rounded mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-medium">Course Outcome ${outcomeNumber} (CO${outcomeNumber})</h4>
                        <button class="remove-outcome text-red-600 hover:text-red-800" data-index="${outcomeNumber - 1}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea class="outcome-description w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none"></textarea>
                    </div>
                </div>
                `;
                
                const outcomesContainer = document.getElementById('outcomes-container');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = outcomeTemplate;
                const outcomeElement = tempDiv.firstElementChild;
                outcomesContainer.appendChild(outcomeElement);
                
                // Attach remove event to the new button
                outcomeElement.querySelector('.remove-outcome').addEventListener('click', function() {
                    if (document.querySelectorAll('.outcome-entry').length > 1) {
                        this.closest('.outcome-entry').remove();
                        reindexOutcomes();
                    } else {
                        showAlert('You must have at least one course outcome', 'warning');
                    }
                });
            }

            // Attach event listener to initial remove outcome button
            document.querySelector('.remove-outcome').addEventListener('click', function() {
                if (document.querySelectorAll('.outcome-entry').length > 1) {
                    this.closest('.outcome-entry').remove();
                    reindexOutcomes();
                } else {
                    showAlert('You must have at least one course outcome', 'warning');
                }
            });
            
            function reindexOutcomes() {
                const outcomes = document.querySelectorAll('.outcome-entry');
                outcomes.forEach((outcome, index) => {
                    const heading = outcome.querySelector('h4');
                    heading.textContent = `Course Outcome ${index + 1} (CO${index + 1})`;
                    outcome.querySelector('.remove-outcome').dataset.index = index;
                });
                outcomeCounter = outcomes.length;
                // Update course outcome filters
                updateCOFilters();
            }

            // Multiselect component for Bloom Levels and Course Outcomes
            class MultiSelect {
                constructor(element, options = []) {
                    this.element = element;
                    this.options = options;
                    this.selectedValues = [];
                    this.isOpen = false;
                    this.render();
                    this.attachEventListeners();
                }

                render() {
                    this.element.innerHTML = `
                    <div class="multiselect border rounded p-1 w-full">
                        <div class="flex justify-between items-center cursor-pointer p-1">
                            <div class="multiselect-tags flex flex-wrap gap-1"></div>
                            <div class="multiselect-arrow">
                                <i class="fas fa-chevron-down text-gray-500"></i>
                            </div>
                        </div>
                        <div class="multiselect-dropdown shadow-lg z-50 rounded-b" style="display: none;">
                            ${this.options.map(option => `
                                <div class="multiselect-option" data-value="${option.value}">
                                    ${option.label}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    `;

                    this.toggleElement = this.element.querySelector('.flex.justify-between');
                    this.tagsContainer = this.element.querySelector('.multiselect-tags');
                    this.dropdown = this.element.querySelector('.multiselect-dropdown');
                    this.arrow = this.element.querySelector('.multiselect-arrow i');
                }

                attachEventListeners() {
                    // Toggle dropdown
                    this.toggleElement.addEventListener('click', () => {
                        this.toggleDropdown();
                    });

                    // Select/deselect options
                    const options = this.element.querySelectorAll('.multiselect-option');
                    options.forEach(option => {
                        option.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const value = option.dataset.value;
                            this.toggleOption(value, option);
                        });
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!this.element.contains(e.target) && this.isOpen) {
                            this.closeDropdown();
                        }
                    });
                }

                toggleDropdown() {
                    this.isOpen = !this.isOpen;
                    this.dropdown.style.display = this.isOpen ? 'block' : 'none';
                    this.arrow.className = this.isOpen ? 'fas fa-chevron-up text-gray-500' : 'fas fa-chevron-down text-gray-500';
                }

                closeDropdown() {
                    this.isOpen = false;
                    this.dropdown.style.display = 'none';
                    this.arrow.className = 'fas fa-chevron-down text-gray-500';
                }

                toggleOption(value, optionElement) {
                    const index = this.selectedValues.indexOf(value);
                    if (index === -1) {
                        // Add option
                        this.selectedValues.push(value);
                        optionElement.classList.add('selected');
                        this.addTag(value, optionElement.textContent.trim());
                    } else {
                        // Remove option
                        this.selectedValues.splice(index, 1);
                        optionElement.classList.remove('selected');
                        this.removeTag(value);
                    }
                    
                    // Trigger change event
                    const event = new Event('change', { bubbles: true });
                    this.element.dispatchEvent(event);
                }

                addTag(value, label) {
                    const tag = document.createElement('div');
                    tag.className = 'multiselect-tag';
                    tag.dataset.value = value;
                    tag.innerHTML = `
                        ${label}
                        <button type="button">&times;</button>
                    `;
                    this.tagsContainer.appendChild(tag);

                    // Add click handler for the remove button
                    tag.querySelector('button').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeValue(value);
                    });
                }

                removeTag(value) {
                    const tag = this.tagsContainer.querySelector(`.multiselect-tag[data-value="${value}"]`);
                    if (tag) {
                        tag.remove();
                    }
                }

                removeValue(value) {
                    const index = this.selectedValues.indexOf(value);
                    if (index !== -1) {
                        this.selectedValues.splice(index, 1);
                        this.removeTag(value);
                        
                        // Update option in dropdown
                        const option = this.element.querySelector(`.multiselect-option[data-value="${value}"]`);
                        if (option) {
                            option.classList.remove('selected');
                        }
                        
                        // Trigger change event
                        const event = new Event('change', { bubbles: true });
                        this.element.dispatchEvent(event);
                    }
                }

                getValue() {
                    return [...this.selectedValues];
                }

                setValue(values) {
                    // Clear current selection
                    this.selectedValues.forEach(value => this.removeTag(value));
                    this.selectedValues = [];
                    
                    // Select new values
                    const options = this.element.querySelectorAll('.multiselect-option');
                    options.forEach(option => {
                        option.classList.remove('selected');
                        if (values.includes(option.dataset.value)) {
                            this.toggleOption(option.dataset.value, option);
                        }
                    });
                }
            }

            // Question Mapping
            document.getElementById('parse-mapping').addEventListener('click', parseMapping);
            document.getElementById('add-mapping-row').addEventListener('click', addMappingRow);
            
            function parseMapping() {
                const mappingText = document.getElementById('mapping-import').value.trim();
                if (!mappingText) {
                    showAlert('Please paste mapping data to import', 'warning');
                    return;
                }
                
                const rows = mappingText.split('\n');
                const result = [];
                
                // Determine if comma or tab separated
                const delimiter = rows[0].includes('\t') ? '\t' : ',';
                
                // Skip header row if it exists
                const startIndex = (rows[0].toLowerCase().includes('unit') || rows[0].toLowerCase().includes('question type')) ? 1 : 0;
                
                for (let i = startIndex; i < rows.length; i++) {
                    const row = rows[i].trim();
                    if (!row) continue;
                    
                    const columns = row.split(delimiter);
                    if (columns.length < 6) {
                        showAlert(`Row ${i+1} has insufficient columns: ${columns.length}/6`, 'error');
                        continue;
                    }
                    
                    result.push({
                        unit: columns[0].trim(),
                        questionType: columns[1].trim(),
                        questionNo: columns[2].trim(),
                        marks: columns[3].trim(),
                        bloomLevel: columns[4].trim(),
                        courseOutcome: columns[5].trim()
                    });
                }
                
                if (result.length > 0) {
                    populateMappingTable(result);
                    showAlert(`Successfully imported ${result.length} mapping entries`, 'success');
                } else {
                    showAlert('No valid mapping entries found in the input', 'error');
                }
            }

            function populateMappingTable(mappings) {
                const tableBody = document.getElementById('mapping-table-body');
                tableBody.innerHTML = '';
                
                mappings.forEach((mapping, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    row.innerHTML = `
                    <td class="py-2 px-3 border-b border-gray-200">${mapping.unit}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${mapping.questionType}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${mapping.questionNo}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${mapping.marks}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${mapping.bloomLevel}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${mapping.courseOutcome}</td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <button class="text-red-600 hover:text-red-800 delete-mapping-row" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-mapping-row').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        this.closest('tr').remove();
                    });
                });
            }

            function addMappingRow() {
                const tableBody = document.getElementById('mapping-table-body');
                const rowCount = tableBody.querySelectorAll('tr').length;
                
                const units = Array.from(document.querySelectorAll('.unit-entry')).map((unit, index) => {
                    return `Unit ${index + 1}`;
                });
                
                const courseOutcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                    return `CO${index + 1}`;
                });
                
                const row = document.createElement('tr');
                row.className = rowCount % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const unitOptions = units.map(unit => `<option value="${unit}">${unit}</option>`).join('');
                const coOptions = courseOutcomes.map(co => `<option value="${co}">${co}</option>`).join('');
                
                row.innerHTML = `
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="border rounded p-1 w-full">
                        ${unitOptions}
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="border rounded p-1 w-full">
                        <option value="MCQ">MCQ</option>
                        <option value="Short Answer">Short Answer</option>
                        <option value="Long Answer">Long Answer</option>
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <input type="text" class="border rounded p-1 w-full" value="${rowCount + 1}">
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <input type="number" class="border rounded p-1 w-full" min="1" max="10" value="1">
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="border rounded p-1 w-full">
                        <option value="Remember">Remember</option>
                        <option value="Understand">Understand</option>
                        <option value="Apply">Apply</option>
                        <option value="Analyze">Analyze</option>
                        <option value="Evaluate">Evaluate</option>
                        <option value="Create">Create</option>
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="border rounded p-1 w-full">
                        ${coOptions}
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <button class="text-red-600 hover:text-red-800 delete-mapping-row" data-index="${rowCount}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
                `;
                
                tableBody.appendChild(row);
                
                // Add event listener to delete button
                row.querySelector('.delete-mapping-row').addEventListener('click', function() {
                    this.closest('tr').remove();
                });
            }

            // Question Distribution
            document.getElementById('add-distribution-row').addEventListener('click', addDistributionRow);
            document.getElementById('generate-distribution').addEventListener('click', generateDistribution);
            
            function addDistributionRow() {
                const tableBody = document.getElementById('distribution-table-body');
                const rowCount = tableBody.querySelectorAll('tr').length;
                
                const units = Array.from(document.querySelectorAll('.unit-entry')).map((unit, index) => {
                    return {
                        id: `Unit ${index + 1}`,
                        title: unit.querySelector('.unit-title').value || `Unit ${index + 1}`
                    };
                });
                
                const courseOutcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                    return {
                        id: `CO${index + 1}`,
                        description: outcome.querySelector('.outcome-description').value || `Course Outcome ${index + 1}`
                    };
                });
                
                const row = document.createElement('tr');
                row.className = rowCount % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const unitOptions = units.map(unit => `<option value="${unit.id}">${unit.id} - ${unit.title}</option>`).join('');
                
                row.innerHTML = `
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="unit-select border rounded p-1 w-full">
                        ${unitOptions}
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="question-type-select border rounded p-1 w-full">
                        <option value="MCQ">MCQ</option>
                        <option value="Short Answer">Short Answer</option>
                        <option value="Long Answer">Long Answer</option>
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <input type="number" class="num-questions border rounded p-1 w-full" min="1" max="100" value="5" oninput="updateDistributionStats()">
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <input type="number" class="marks-per-question border rounded p-1 w-full" min="1" max="10" value="1" oninput="updateDistributionStats()">
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <div class="bloom-select-container"></div>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <div class="co-select-container"></div>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <select class="difficulty-select border rounded p-1 w-full">
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Difficult">Difficult</option>
                    </select>
                </td>
                <td class="py-2 px-3 border-b border-gray-200">
                    <button class="text-red-600 hover:text-red-800 delete-distribution-row">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
                `;
                
                tableBody.appendChild(row);
                
                // Initialize multiselect for Bloom levels
                const bloomOptions = [
                    { value: 'Remember', label: 'Remember' },
                    { value: 'Understand', label: 'Understand' },
                    { value: 'Apply', label: 'Apply' },
                    { value: 'Analyze', label: 'Analyze' },
                    { value: 'Evaluate', label: 'Evaluate' },
                    { value: 'Create', label: 'Create' }
                ];
                
                const bloomSelectContainer = row.querySelector('.bloom-select-container');
                const bloomMultiSelect = new MultiSelect(bloomSelectContainer, bloomOptions);
                bloomMultiSelect.setValue(['Remember']); // Default value
                
                // Initialize multiselect for Course Outcomes
                const coOptions = courseOutcomes.map(co => ({
                    value: co.id,
                    label: `${co.id}`
                }));
                
                const coSelectContainer = row.querySelector('.co-select-container');
                const coMultiSelect = new MultiSelect(coSelectContainer, coOptions);
                if (coOptions.length > 0) {
                    coMultiSelect.setValue([coOptions[0].value]); // Default value
                }
                
                // Store multselect instances in the row for access later
                row.bloomMultiSelect = bloomMultiSelect;
                row.coMultiSelect = coMultiSelect;
                
                // Add event listener to delete button
                row.querySelector('.delete-distribution-row').addEventListener('click', function() {
                    this.closest('tr').remove();
                    updateDistributionStats();
                });
                
                // Initialize onchange handlers for the inputs
                row.querySelectorAll('input, select').forEach(input => {
                    input.addEventListener('change', updateDistributionStats);
                });
                
                // Add change event listeners to multiselects
                bloomSelectContainer.addEventListener('change', updateDistributionStats);
                coSelectContainer.addEventListener('change', updateDistributionStats);
                
                updateDistributionStats();
            }

            // Add the updateDistributionStats function to window so it can be called from inline handlers
            window.updateDistributionStats = function() {
                // Calculate total marks, total questions, and percentages by question type
                let totalMarks = 0;
                let totalQuestions = 0;
                let mcqCount = 0;
                let shortCount = 0;
                let longCount = 0;
                
                const rows = document.querySelectorAll('#distribution-table-body tr');
                
                rows.forEach(row => {
                    const numQuestions = parseInt(row.querySelector('.num-questions').value) || 0;
                    const marksPerQuestion = parseInt(row.querySelector('.marks-per-question').value) || 0;
                    const questionType = row.querySelector('.question-type-select').value;
                    
                    totalMarks += numQuestions * marksPerQuestion;
                    totalQuestions += numQuestions;
                    
                    if (questionType === 'MCQ') {
                        mcqCount += numQuestions;
                    } else if (questionType === 'Short Answer') {
                        shortCount += numQuestions;
                    } else if (questionType === 'Long Answer') {
                        longCount += numQuestions;
                    }
                });
                
                const mcqPercentage = totalQuestions > 0 ? Math.round((mcqCount / totalQuestions) * 100) : 0;
                const shortPercentage = totalQuestions > 0 ? Math.round((shortCount / totalQuestions) * 100) : 0;
                const longPercentage = totalQuestions > 0 ? Math.round((longCount / totalQuestions) * 100) : 0;
                
                // Update stats display
                document.getElementById('total-marks').textContent = totalMarks;
                document.getElementById('total-questions').textContent = totalQuestions;
                document.getElementById('mcq-percentage').textContent = `${mcqPercentage}%`;
                document.getElementById('short-percentage').textContent = `${shortPercentage}%`;
                document.getElementById('long-percentage').textContent = `${longPercentage}%`;
                
                // Update unit distribution chart
                updateUnitDistributionChart();
            };

            function updateUnitDistributionChart() {
                const unitChart = document.getElementById('unit-distribution-chart');
                unitChart.innerHTML = '';
                
                const rows = document.querySelectorAll('#distribution-table-body tr');
                const unitCounts = {};
                let totalQuestions = 0;
                
                // Count questions per unit
                rows.forEach(row => {
                    const unit = row.querySelector('.unit-select').value;
                    const numQuestions = parseInt(row.querySelector('.num-questions').value) || 0;
                    
                    if (!unitCounts[unit]) {
                        unitCounts[unit] = 0;
                    }
                    
                    unitCounts[unit] += numQuestions;
                    totalQuestions += numQuestions;
                });
                
                // Create chart bars
                if (totalQuestions > 0) {
                    const unitColors = [
                        'bg-blue-500',
                        'bg-green-500',
                        'bg-purple-500',
                        'bg-red-500',
                        'bg-yellow-500',
                        'bg-indigo-500',
                        'bg-pink-500',
                        'bg-teal-500'
                    ];
                    
                    let colorIndex = 0;
                    
                    for (const unit in unitCounts) {
                        const percentage = (unitCounts[unit] / totalQuestions) * 100;
                        const color = unitColors[colorIndex % unitColors.length];
                        
                        const bar = document.createElement('div');
                        bar.className = `${color} h-full relative tooltip`;
                        bar.style.width = `${percentage}%`;
                        
                        const tooltip = document.createElement('span');
                        tooltip.className = 'tooltiptext';
                        tooltip.textContent = `${unit}: ${unitCounts[unit]} questions (${Math.round(percentage)}%)`;
                        
                        bar.appendChild(tooltip);
                        unitChart.appendChild(bar);
                        
                        colorIndex++;
                    }
                } else {
                    unitChart.innerHTML = '<div class="text-gray-400 text-center w-full">No distribution data</div>';
                }
            }

            function generateDistribution() {
                // This function automatically generates a balanced distribution based on syllabus
                const units = Array.from(document.querySelectorAll('.unit-entry')).map((unit, index) => {
                    return {
                        id: `Unit ${index + 1}`,
                        title: unit.querySelector('.unit-title').value || `Unit ${index + 1}`,
                        topics: (unit.querySelector('.unit-topics').value || '').split('\n').filter(t => t.trim())
                    };
                });
                
                const outcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                    return {
                        id: `CO${index + 1}`,
                        description: outcome.querySelector('.outcome-description').value || `Course Outcome ${index + 1}`
                    };
                });
                
                if (units.length === 0) {
                    showAlert('Please define at least one syllabus unit first', 'warning');
                    return;
                }
                
                if (outcomes.length === 0) {
                    showAlert('Please define at least one course outcome first', 'warning');
                    return;
                }
                
                // Generate a simple distribution with some variety across question types, bloom levels, etc.
                const distribution = [];
                const questionTypes = ['MCQ', 'Short Answer', 'Long Answer'];
                const bloomLevels = ['Remember', 'Understand', 'Apply', 'Analyze', 'Evaluate', 'Create'];
                const difficulties = ['Easy', 'Medium', 'Difficult'];
                
                // For each unit, create a mix of question types
                units.forEach(unit => {
                    // MCQs (easier levels)
                    distribution.push({
                        unit: unit.id,
                        questionType: 'MCQ',
                        numQuestions: 5,
                        marks: 1,
                        bloomLevel: ['Remember', 'Understand'], // Multiple bloom levels
                        courseOutcome: [outcomes[0].id, outcomes.length > 1 ? outcomes[1].id : outcomes[0].id], // Multiple COs
                        difficulty: 'Easy'
                    });
                    
                    // Short answers (middle levels)
                    distribution.push({
                        unit: unit.id,
                        questionType: 'Short Answer',
                        numQuestions: 3,
                        marks: 3,
                        bloomLevel: ['Apply', 'Analyze'], // Multiple bloom levels
                        courseOutcome: outcomes.map(co => co.id).slice(0, 2), // First two COs
                        difficulty: 'Medium'
                    });
                    
                    // Long answers (higher levels)
                    distribution.push({
                        unit: unit.id,
                        questionType: 'Long Answer',
                        numQuestions: 2,
                        marks: 5,
                        bloomLevel: ['Evaluate', 'Create'], // Multiple bloom levels
                        courseOutcome: outcomes.map(co => co.id), // All COs
                        difficulty: 'Difficult'
                    });
                });
                
                // Display the automatic distribution
                displayAutoDistribution(distribution);
            }

            function displayAutoDistribution(distribution) {
                const tableBody = document.getElementById('auto-distribution-body');
                tableBody.innerHTML = '';
                
                distribution.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    row.innerHTML = `
                    <td class="py-2 px-3 border-b border-gray-200">${item.unit}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${item.questionType}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${item.numQuestions}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${item.marks}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${Array.isArray(item.bloomLevel) ? item.bloomLevel.join(', ') : item.bloomLevel}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${Array.isArray(item.courseOutcome) ? item.courseOutcome.join(', ') : item.courseOutcome}</td>
                    <td class="py-2 px-3 border-b border-gray-200">${item.difficulty}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                showAlert('Auto-distribution generated successfully. Click "Apply this Distribution" to use it.', 'success');
                
                // Add apply button
                const applyBtn = document.createElement('button');
                applyBtn.className = 'mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition';
                applyBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Apply this Distribution';
                applyBtn.addEventListener('click', function() {
                    applyAutoDistribution(distribution);
                });
                
                // Replace any existing apply button
                const existingBtn = document.querySelector('#apply-auto-distribution');
                if (existingBtn) {
                    existingBtn.remove();
                }
                
                applyBtn.id = 'apply-auto-distribution';
                document.getElementById('auto-distribution-body').parentNode.after(applyBtn);
            }

            function applyAutoDistribution(distribution) {
                // Clear existing distribution
                document.getElementById('distribution-table-body').innerHTML = '';
                
                // Add each entry from auto-distribution
                distribution.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white';
                    
                    row.innerHTML = `
                    <td class="py-2 px-3 border-b border-gray-200">
                        <select class="unit-select border rounded p-1 w-full">
                            <option value="${item.unit}" selected>${item.unit}</option>
                        </select>
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <select class="question-type-select border rounded p-1 w-full">
                            <option value="MCQ" ${item.questionType === 'MCQ' ? 'selected' : ''}>MCQ</option>
                            <option value="Short Answer" ${item.questionType === 'Short Answer' ? 'selected' : ''}>Short Answer</option>
                            <option value="Long Answer" ${item.questionType === 'Long Answer' ? 'selected' : ''}>Long Answer</option>
                        </select>
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <input type="number" class="num-questions border rounded p-1 w-full" min="1" max="100" value="${item.numQuestions}">
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <input type="number" class="marks-per-question border rounded p-1 w-full" min="1" max="10" value="${item.marks}">
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <div class="bloom-select-container"></div>
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <div class="co-select-container"></div>
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <select class="difficulty-select border rounded p-1 w-full">
                            <option value="Easy" ${item.difficulty === 'Easy' ? 'selected' : ''}>Easy</option>
                            <option value="Medium" ${item.difficulty === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Difficult" ${item.difficulty === 'Difficult' ? 'selected' : ''}>Difficult</option>
                        </select>
                    </td>
                    <td class="py-2 px-3 border-b border-gray-200">
                        <button class="text-red-600 hover:text-red-800 delete-distribution-row">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    `;
                    
                    document.getElementById('distribution-table-body').appendChild(row);
                    
                    // Initialize multiselect for Bloom levels
                    const bloomOptions = [
                        { value: 'Remember', label: 'Remember' },
                        { value: 'Understand', label: 'Understand' },
                        { value: 'Apply', label: 'Apply' },
                        { value: 'Analyze', label: 'Analyze' },
                        { value: 'Evaluate', label: 'Evaluate' },
                        { value: 'Create', label: 'Create' }
                    ];
                    
                    const bloomSelectContainer = row.querySelector('.bloom-select-container');
                    const bloomMultiSelect = new MultiSelect(bloomSelectContainer, bloomOptions);
                    
                    // Set selected bloom levels
                    const bloomLevels = Array.isArray(item.bloomLevel) ? item.bloomLevel : [item.bloomLevel];
                    bloomMultiSelect.setValue(bloomLevels);
                    
                    // Initialize multiselect for Course Outcomes
                    const courseOutcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                        return {
                            id: `CO${index + 1}`,
                            description: outcome.querySelector('.outcome-description').value || `Course Outcome ${index + 1}`
                        };
                    });
                    
                    const coOptions = courseOutcomes.map(co => ({
                        value: co.id,
                        label: `${co.id}`
                    }));
                    
                    const coSelectContainer = row.querySelector('.co-select-container');
                    const coMultiSelect = new MultiSelect(coSelectContainer, coOptions);
                    
                    // Set selected course outcomes
                    const selectedCOs = Array.isArray(item.courseOutcome) ? item.courseOutcome : [item.courseOutcome];
                    coMultiSelect.setValue(selectedCOs);
                    
                    // Store multselect instances in the row for access later
                    row.bloomMultiSelect = bloomMultiSelect;
                    row.coMultiSelect = coMultiSelect;
                    
                    // Add event listener to delete button
                    row.querySelector('.delete-distribution-row').addEventListener('click', function() {
                        this.closest('tr').remove();
                        updateDistributionStats();
                    });
                    
                    // Add change event listeners to multiselects
                    bloomSelectContainer.addEventListener('change', updateDistributionStats);
                    coSelectContainer.addEventListener('change', updateDistributionStats);
                });
                
                updateDistributionStats();
                showAlert('Distribution applied successfully', 'success');
            }

            // AI Question Generation
            document.getElementById('generate-questions').addEventListener('click', generateQuestions);
            
            async function generateQuestions() {
                const apiKey = localStorage.getItem('geminiApiKey');
                
                if (!apiKey) {
                    showAlert('Please validate your API key first', 'error');
                    showSection('api-key');
                    return;
                }
                
                // Get syllabus units
                const units = Array.from(document.querySelectorAll('.unit-entry')).map((unit, index) => {
                    return {
                        id: `Unit ${index + 1}`,
                        title: unit.querySelector('.unit-title').value || `Unit ${index + 1}`,
                        topics: (unit.querySelector('.unit-topics').value || '').split('\n').filter(t => t.trim())
                    };
                });
                
                // Get course outcomes
                const outcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                    return {
                        id: `CO${index + 1}`,
                        description: outcome.querySelector('.outcome-description').value || `Course Outcome ${index + 1}`
                    };
                });
                
                // Get question distribution
                const distribution = Array.from(document.querySelectorAll('#distribution-table-body tr')).map(row => {
                    return {
                        unit: row.querySelector('.unit-select').value,
                        questionType: row.querySelector('.question-type-select').value,
                        numQuestions: parseInt(row.querySelector('.num-questions').value) || 0,
                        marks: parseInt(row.querySelector('.marks-per-question').value) || 0,
                        bloomLevel: row.bloomMultiSelect ? row.bloomMultiSelect.getValue() : ['Remember'],
                        courseOutcome: row.coMultiSelect ? row.coMultiSelect.getValue() : [outcomes[0]?.id],
                        difficulty: row.querySelector('.difficulty-select').value
                    };
                });
                
                if (units.length === 0) {
                    showAlert('Please define at least one syllabus unit first', 'warning');
                    showSection('syllabus-outcomes');
                    return;
                }
                
                if (outcomes.length === 0) {
                    showAlert('Please define at least one course outcome first', 'warning');
                    showSection('syllabus-outcomes');
                    return;
                }
                
                if (distribution.length === 0) {
                    showAlert('Please define at least one question distribution entry', 'warning');
                    showSection('question-distribution');
                    return;
                }
                
                // Show generation status
                document.getElementById('generation-status').classList.remove('hidden');
                
                // Create a structured prompt for Gemini API that clearly includes all requirements
                const courseCode = document.getElementById('courseCode').value || 'Course';
                const courseTitle = document.getElementById('courseTitle').value || 'Untitled Course';
                const courseDescription = document.getElementById('courseDescription').value || '';
                
                let prompt = `As an expert in educational assessment, generate questions for the following course: Course: ${courseCode} - ${courseTitle} ${courseDescription ? `Description: ${courseDescription}\n\n` : ''} SYLLABUS UNITS: `;
                
                // Add syllabus units with topics
                units.forEach(unit => {
                    prompt += `${unit.id}: ${unit.title}\n`;
                    unit.topics.forEach(topic => {
                        prompt += `- ${topic}\n`;
                    });
                    prompt += '\n';
                });
                
                prompt += 'COURSE OUTCOMES:\n';
                outcomes.forEach(outcome => {
                    prompt += `${outcome.id}: ${outcome.description}\n`;
                });
                
                prompt += `\nQUESTION REQUIREMENTS: I need you to generate questions based on the following specific requirements. Each requirement specifies the unit, question type, bloom's taxonomy level, course outcome alignment, and difficulty level: `;
                
                // Add distribution requirements
                distribution.forEach(item => {
                    const bloomLevels = Array.isArray(item.bloomLevel) ? item.bloomLevel.join('/') : item.bloomLevel;
                    const courseOutcomes = Array.isArray(item.courseOutcome) ? item.courseOutcome.join('/') : item.courseOutcome;
                    
                    prompt += `- Generate ${item.numQuestions} ${item.questionType} questions for ${item.unit} at the ${bloomLevels} cognitive level(s), aligned with ${courseOutcomes}, at ${item.difficulty} difficulty level (${item.marks} marks each).\n`;
                });
                
                prompt += `\nFor each question, please provide: 
1. The exact question text 
2. The correct answer 
3. (For MCQs) All answer options including distractors 
4. The specific topic from the syllabus that the question addresses 
5. The Bloom's taxonomy level 
6. The course outcome it aligns with 
7. The difficulty level 
8. The marks assigned 

Format your response as structured JSON to ensure proper parsing. For MCQs, include options labeled A, B, C, D WITHOUT radio buttons or any highlighting of correct answers. 

For each question, explain why it tests the specified Bloom's level and how it aligns with the course outcome. Return your response in this JSON format: 

{
  "questions": [
    {
      "id": "Q1",
      "unit": "Unit X",
      "type": "MCQ/Short Answer/Long Answer",
      "text": "Question text goes here?",
      "topic": "Specific topic from syllabus",
      "options": ["A. Option A", "B. Option B", "C. Option C", "D. Option D"],
      "correctAnswer": "A. Option A",
      "explanation": "Explanation of why this is correct",
      "bloomLevel": "Remember/Understand/Apply/Analyze/Evaluate/Create",
      "courseOutcome": "CO1/CO2/etc.",
      "difficulty": "Easy/Medium/Difficult",
      "marks": 1
    }
  ]
}

For short answer and long answer questions, omit the "options" field.`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.2,
                                maxOutputTokens: 8192,
                                topP: 0.8,
                                topK: 40
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'API error');
                    }
                    
                    // Extract JSON from Gemini response text
                    let generatedQuestions;
                    
                    try {
                        const responseText = data.candidates[0].content.parts[0].text;
                        const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || responseText.match(/{[\s\S]*?}/);
                        
                        if (jsonMatch) {
                            const jsonStr = jsonMatch[1] || jsonMatch[0];
                            generatedQuestions = JSON.parse(jsonStr);
                        } else {
                            // Try to extract JSON without code blocks
                            const startIndex = responseText.indexOf('{');
                            const endIndex = responseText.lastIndexOf('}') + 1;
                            
                            if (startIndex !== -1 && endIndex !== -1) {
                                const jsonStr = responseText.substring(startIndex, endIndex);
                                generatedQuestions = JSON.parse(jsonStr);
                            } else {
                                throw new Error('Could not extract JSON from response');
                            }
                        }
                    } catch (e) {
                        console.error('JSON parsing error:', e);
                        throw new Error('Failed to parse generated questions. API response format unexpected.');
                    }
                    
                    // Display the generated questions
                    displayGeneratedQuestions(generatedQuestions);
                    
                    // Update filters
                    updateFilters();
                    
                    // Hide generation status
                    document.getElementById('generation-status').classList.add('hidden');
                    
                    showAlert('Questions generated successfully!', 'success');
                } catch (error) {
                    console.error('Question generation error:', error);
                    document.getElementById('generation-status').classList.add('hidden');
                    showAlert(`Failed to generate questions: ${error.message}`, 'error');
                }
            }

            function displayGeneratedQuestions(data) {
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                
                if (!data || !data.questions || data.questions.length === 0) {
                    container.innerHTML = `
                    <div class="text-gray-500 text-center py-10">
                        <i class="fas fa-exclamation-circle text-4xl mb-4 text-yellow-500"></i>
                        <p>No questions were generated. Please check your input and try again.</p>
                    </div>
                    `;
                    return;
                }
                
                // Store questions in window for filtering
                window.generatedQuestions = data.questions;
                
                // Display all questions initially
                renderFilteredQuestions(data.questions);
            }

            function renderFilteredQuestions(questions) {
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                
                questions.forEach((question, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border rounded-lg shadow-sm p-4 mb-6';
                    
                    let optionsHtml = '';
                    
                    if (question.type === 'MCQ' && question.options && question.options.length > 0) {
                        optionsHtml = `
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${question.options.map(option => {
                                return `<div class="flex items-start p-2">
                                    <div class="ml-2">
                                        ${option}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                        `;
                    }
                    
                    // Added metadata display after question
                    const metadataHtml = `
                    <div class="mt-3 text-sm text-gray-600">
                        <p>Bloom Level: ${question.bloomLevel} | CO: ${question.courseOutcome} | Marks: ${question.marks}</p>
                    </div>
                    `;
                    
                    // Updated question numbering to show only Q1 instead of Q1 (Q1)
                    card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-medium text-gray-900">Q${index + 1}</h3>
                        <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">${question.topic}</span>
                    </div>
                    <div class="mt-3 text-gray-700">
                        ${question.text}
                    </div>
                    ${metadataHtml}
                    ${optionsHtml}
                    `;
                    
                    container.appendChild(card);
                });
                
                if (questions.length === 0) {
                    container.innerHTML = `
                    <div class="text-gray-500 text-center py-10">
                        <i class="fas fa-filter text-4xl mb-4 text-blue-500"></i>
                        <p>No questions match your current filters.</p>
                        <p class="text-sm mt-2">Try changing your filter settings to see more questions.</p>
                    </div>
                    `;
                }
            }

            // Question filtering
            function updateFilters() {
                if (!window.generatedQuestions) return;
                
                // Get all units
                const unitFilter = document.getElementById('filter-unit');
                unitFilter.innerHTML = '<option value="all">All Units</option>';
                
                const units = Array.from(new Set(window.generatedQuestions.map(q => q.unit)));
                units.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitFilter.appendChild(option);
                });
                
                // Get all course outcomes
                const coFilter = document.getElementById('filter-co');
                coFilter.innerHTML = '<option value="all">All Course Outcomes</option>';
                
                const outcomes = Array.from(new Set(window.generatedQuestions.map(q => q.courseOutcome)));
                outcomes.forEach(co => {
                    const option = document.createElement('option');
                    option.value = co;
                    option.textContent = co;
                    coFilter.appendChild(option);
                });
                
                // Add event listeners to all filters
                document.querySelectorAll('#question-filters select').forEach(filter => {
                    filter.addEventListener('change', applyFilters);
                });
            }

            function updateUnitFilters() {
                const units = Array.from(document.querySelectorAll('.unit-entry')).map((unit, index) => {
                    return `Unit ${index + 1}`;
                });
                
                const unitFilter = document.getElementById('filter-unit');
                if (unitFilter) {
                    unitFilter.innerHTML = '<option value="all">All Units</option>';
                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        unitFilter.appendChild(option);
                    });
                }
            }

            function updateCOFilters() {
                const outcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                    return `CO${index + 1}`;
                });
                
                const coFilter = document.getElementById('filter-co');
                if (coFilter) {
                    coFilter.innerHTML = '<option value="all">All Course Outcomes</option>';
                    outcomes.forEach(co => {
                        const option = document.createElement('option');
                        option.value = co;
                        option.textContent = co;
                        coFilter.appendChild(option);
                    });
                }
            }

            function applyFilters() {
                if (!window.generatedQuestions) return;
                
                const unitFilter = document.getElementById('filter-unit').value;
                const typeFilter = document.getElementById('filter-type').value;
                const bloomFilter = document.getElementById('filter-bloom').value;
                const coFilter = document.getElementById('filter-co').value;
                
                const filteredQuestions = window.generatedQuestions.filter(question => {
                    return (unitFilter === 'all' || question.unit === unitFilter) &&
                           (typeFilter === 'all' || question.type === typeFilter) &&
                           (bloomFilter === 'all' || question.bloomLevel === bloomFilter) &&
                           (coFilter === 'all' || question.courseOutcome === coFilter);
                });
                
                renderFilteredQuestions(filteredQuestions);
            }

            // Alert function
            function showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                const alert = document.getElementById('alert');
                
                // Set alert type
                if (type === 'success') {
                    alert.className = 'p-4 rounded bg-green-100 text-green-800';
                    alert.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                } else if (type === 'warning') {
                    alert.className = 'p-4 rounded bg-yellow-100 text-yellow-800';
                    alert.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
                } else if (type === 'error') {
                    alert.className = 'p-4 rounded bg-red-100 text-red-800';
                    alert.innerHTML = `<i class="fas fa-times-circle mr-2"></i>${message}`;
                } else {
                    alert.className = 'p-4 rounded bg-blue-100 text-blue-800';
                    alert.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
                }
                
                alertContainer.classList.remove('hidden');
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertContainer.classList.add('hidden');
                }, 5000);
            }

            // Save and Load functionality
            document.getElementById('save-btn').addEventListener('click', saveData);
            document.getElementById('load-btn').addEventListener('click', loadData);
            document.getElementById('export-questions-html').addEventListener('click', exportQuestionsHTML);
            document.getElementById('export-questions-word').addEventListener('click', exportQuestionsWord);
            
            function saveData() {
                // Collect all data from the form
                const courseData = {
                    course: {
                        code: document.getElementById('courseCode').value,
                        title: document.getElementById('courseTitle').value,
                        credits: document.getElementById('credits').value,
                        department: document.getElementById('department').value,
                        description: document.getElementById('courseDescription').value
                    },
                    syllabus: {
                        units: Array.from(document.querySelectorAll('.unit-entry')).map((unit, index) => {
                            return {
                                number: index + 1,
                                title: unit.querySelector('.unit-title').value,
                                topics: unit.querySelector('.unit-topics').value
                            };
                        })
                    },
                    outcomes: Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                        return {
                            id: `CO${index + 1}`,
                            description: outcome.querySelector('.outcome-description').value
                        };
                    }),
                    distribution: Array.from(document.querySelectorAll('#distribution-table-body tr')).map(row => {
                        return {
                            unit: row.querySelector('.unit-select').value,
                            questionType: row.querySelector('.question-type-select').value,
                            numQuestions: row.querySelector('.num-questions').value,
                            marks: row.querySelector('.marks-per-question').value,
                            bloomLevel: row.bloomMultiSelect ? row.bloomMultiSelect.getValue() : ['Remember'],
                            courseOutcome: row.coMultiSelect ? row.coMultiSelect.getValue() : ['CO1'],
                            difficulty: row.querySelector('.difficulty-select').value
                        };
                    }),
                    questions: window.generatedQuestions || []
                };
                
                // Convert to JSON and save to file
                const dataStr = JSON.stringify(courseData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportName = `question_bank_${courseData.course.code || 'course'}_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportName);
                linkElement.click();
                
                showAlert('Data saved successfully!', 'success');
            }

            function loadData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) {
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            populateFormFromData(data);
                            showAlert('Data loaded successfully!', 'success');
                        } catch (error) {
                            showAlert('Error parsing file: ' + error.message, 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            }

            function populateFormFromData(data) {
                // Populate course details
                if (data.course) {
                    document.getElementById('courseCode').value = data.course.code || '';
                    document.getElementById('courseTitle').value = data.course.title || '';
                    document.getElementById('credits').value = data.course.credits || '';
                    document.getElementById('department').value = data.course.department || '';
                    document.getElementById('courseDescription').value = data.course.description || '';
                }
                
                // Populate syllabus units
                if (data.syllabus && data.syllabus.units) {
                    const unitsContainer = document.getElementById('units-container');
                    unitsContainer.innerHTML = '';
                    
                    data.syllabus.units.forEach((unit, index) => {
                        const unitElement = document.createElement('div');
                        unitElement.className = 'unit-entry bg-gray-50 p-4 rounded mb-4';
                        unitElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-lg font-medium">Unit ${index + 1}</h4>
                            <button class="remove-unit text-red-600 hover:text-red-800" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit Title</label>
                            <input type="text" class="unit-title w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none" value="${unit.title || ''}">
                        </div>
                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Topics (one per line)</label>
                            <textarea class="unit-topics w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">${unit.topics || ''}</textarea>
                        </div>
                        `;
                        unitsContainer.appendChild(unitElement);
                        
                        // Attach remove event
                        unitElement.querySelector('.remove-unit').addEventListener('click', function() {
                            if (document.querySelectorAll('.unit-entry').length > 1) {
                                this.closest('.unit-entry').remove();
                                reindexUnits();
                            } else {
                                showAlert('You must have at least one unit', 'warning');
                            }
                        });
                    });
                    
                    unitCounter = data.syllabus.units.length;
                }
                
                // Populate course outcomes
                if (data.outcomes) {
                    const outcomesContainer = document.getElementById('outcomes-container');
                    outcomesContainer.innerHTML = '';
                    
                    data.outcomes.forEach((outcome, index) => {
                        const outcomeElement = document.createElement('div');
                        outcomeElement.className = 'outcome-entry bg-gray-50 p-4 rounded mb-4';
                        outcomeElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-lg font-medium">Course Outcome ${index + 1} (CO${index + 1})</h4>
                            <button class="remove-outcome text-red-600 hover:text-red-800" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea class="outcome-description w-full p-2 border rounded focus:ring focus:ring-blue-300 focus:outline-none">${outcome.description || ''}</textarea>
                        </div>
                        `;
                        outcomesContainer.appendChild(outcomeElement);
                        
                        // Attach remove event
                        outcomeElement.querySelector('.remove-outcome').addEventListener('click', function() {
                            if (document.querySelectorAll('.outcome-entry').length > 1) {
                                this.closest('.outcome-entry').remove();
                                reindexOutcomes();
                            } else {
                                showAlert('You must have at least one course outcome', 'warning');
                            }
                        });
                    });
                    
                    outcomeCounter = data.outcomes.length;
                }
                
                // Populate distribution
                if (data.distribution) {
                    document.getElementById('distribution-table-body').innerHTML = '';
                    
                    data.distribution.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white';
                        
                        row.innerHTML = `
                        <td class="py-2 px-3 border-b border-gray-200">
                            <select class="unit-select border rounded p-1 w-full">
                                <option value="${item.unit}" selected>${item.unit}</option>
                            </select>
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <select class="question-type-select border rounded p-1 w-full">
                                <option value="MCQ" ${item.questionType === 'MCQ' ? 'selected' : ''}>MCQ</option>
                                <option value="Short Answer" ${item.questionType === 'Short Answer' ? 'selected' : ''}>Short Answer</option>
                                <option value="Long Answer" ${item.questionType === 'Long Answer' ? 'selected' : ''}>Long Answer</option>
                            </select>
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <input type="number" class="num-questions border rounded p-1 w-full" min="1" max="100" value="${item.numQuestions}">
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <input type="number" class="marks-per-question border rounded p-1 w-full" min="1" max="10" value="${item.marks}">
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <div class="bloom-select-container"></div>
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <div class="co-select-container"></div>
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <select class="difficulty-select border rounded p-1 w-full">
                                <option value="Easy" ${item.difficulty === 'Easy' ? 'selected' : ''}>Easy</option>
                                <option value="Medium" ${item.difficulty === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Difficult" ${item.difficulty === 'Difficult' ? 'selected' : ''}>Difficult</option>
                            </select>
                        </td>
                        <td class="py-2 px-3 border-b border-gray-200">
                            <button class="text-red-600 hover:text-red-800 delete-distribution-row">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        `;
                        
                        document.getElementById('distribution-table-body').appendChild(row);
                        
                        // Initialize multiselect for Bloom levels
                        const bloomOptions = [
                            { value: 'Remember', label: 'Remember' },
                            { value: 'Understand', label: 'Understand' },
                            { value: 'Apply', label: 'Apply' },
                            { value: 'Analyze', label: 'Analyze' },
                            { value: 'Evaluate', label: 'Evaluate' },
                            { value: 'Create', label: 'Create' }
                        ];
                        
                        const bloomSelectContainer = row.querySelector('.bloom-select-container');
                        const bloomMultiSelect = new MultiSelect(bloomSelectContainer, bloomOptions);
                        
                        // Set selected bloom levels
                        const bloomLevels = Array.isArray(item.bloomLevel) ? item.bloomLevel : [item.bloomLevel];
                        bloomMultiSelect.setValue(bloomLevels);
                        
                        // Initialize multiselect for Course Outcomes
                        const courseOutcomes = Array.from(document.querySelectorAll('.outcome-entry')).map((outcome, index) => {
                            return {
                                id: `CO${index + 1}`,
                                description: outcome.querySelector('.outcome-description').value || `Course Outcome ${index + 1}`
                            };
                        });
                        
                        const coOptions = courseOutcomes.map(co => ({
                            value: co.id,
                            label: `${co.id}`
                        }));
                        
                        const coSelectContainer = row.querySelector('.co-select-container');
                        const coMultiSelect = new MultiSelect(coSelectContainer, coOptions);
                        
                        // Set selected course outcomes
                        const selectedCOs = Array.isArray(item.courseOutcome) ? item.courseOutcome : [item.courseOutcome];
                        coMultiSelect.setValue(selectedCOs);
                        
                        // Store multselect instances in the row for access later
                        row.bloomMultiSelect = bloomMultiSelect;
                        row.coMultiSelect = coMultiSelect;
                        
                        // Add event listener to delete button
                        row.querySelector('.delete-distribution-row').addEventListener('click', function() {
                            this.closest('tr').remove();
                            updateDistributionStats();
                        });
                        
                        // Add change event listeners to multiselects
                        bloomSelectContainer.addEventListener('change', updateDistributionStats);
                        coSelectContainer.addEventListener('change', updateDistributionStats);
                    });
                    
                    updateDistributionStats();
                }
                
                // Load questions if available
                if (data.questions && data.questions.length > 0) {
                    window.generatedQuestions = data.questions;
                    displayGeneratedQuestions({ questions: data.questions });
                    updateFilters();
                }
                
                // Update filters
                updateUnitFilters();
                updateCOFilters();
            }

            function exportQuestionsHTML() {
                if (!window.generatedQuestions || window.generatedQuestions.length === 0) {
                    showAlert('No questions to export. Please generate questions first.', 'warning');
                    return;
                }
                
                const courseCode = document.getElementById('courseCode').value || 'Course';
                const courseTitle = document.getElementById('courseTitle').value || 'Untitled';
                
                // Create HTML for export
                let html = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Question Bank: ${courseCode} - ${courseTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                        h1, h2, h3 { margin-top: 0; }
                        .question { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; page-break-inside: avoid; }
                        .mcq-option { margin: 5px 0; padding: 5px; }
                        .metadata { margin-top: 10px; font-size: 0.9em; color: #555; }
                        .tag { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 12px; font-size: 0.8em; }
                        .answer-key { page-break-before: always; }
                        .answer-list { column-count: 3; }
                        @media print { body { padding: 0; } .question { border: none; border-bottom: 1px solid #eee; } }
                    </style>
                </head>
                <body>
                    <h1>${courseCode}: ${courseTitle}</h1>
                    <p>Generated Question Bank</p>
                    <h2>Questions</h2>
                `;
                
                // Add each question without answers
                window.generatedQuestions.forEach((question, index) => {
                    html += `
                    <div class="question">
                        <h3>Q${index + 1}</h3>
                        <p><strong>Unit:</strong> ${question.unit} | <strong>Topic:</strong> ${question.topic}</p>
                        <p>${question.text}</p>
                        <div class="metadata">
                            <p>Bloom Level: ${question.bloomLevel} | CO: ${question.courseOutcome} | Marks: ${question.marks}</p>
                        </div>
                    `;
                    
                    if (question.type === 'MCQ' && question.options && question.options.length > 0) {
                        html += '<div class="options">';
                        question.options.forEach(option => {
                            html += `<div class="mcq-option">${option}</div>`;
                        });
                        html += '</div>';
                    }
                    
                    html += `</div>`;
                });
                
                // Add a separate answer key section
                html += `
                    <div class="answer-key">
                        <h2>Answer Key</h2>
                        <div class="answer-list">
                `;
                
                // Add all answers in a compact format
                window.generatedQuestions.forEach((question, index) => {
                    html += `<p><strong>Q${index + 1}:</strong> ${question.correctAnswer}</p>`;
                });
                
                html += `
                        </div>
                    </div>
                </body>
                </html>
                `;
                
                // Create data URI and download
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${courseCode}_question_bank.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('Questions exported to HTML successfully!', 'success');
            }

            function exportQuestionsWord() {
                if (!window.generatedQuestions || window.generatedQuestions.length === 0) {
                    showAlert('No questions to export. Please generate questions first.', 'warning');
                    return;
                }
                
                const courseCode = document.getElementById('courseCode').value || 'Course';
                const courseTitle = document.getElementById('courseTitle').value || 'Untitled';
                
                // Create HTML for Word export with separate answer key
                let html = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Question Bank: ${courseCode} - ${courseTitle}</title>
                    <style>
                        body { font-family: 'Calibri', sans-serif; }
                        .question { margin-bottom: 20px; }
                        .metadata { margin-top: 10px; font-style: italic; }
                        .answer-key { page-break-before: always; }
                        .answer-table { width: 100%; border-collapse: collapse; }
                        .answer-table td, .answer-table th { border: 1px solid #ddd; padding: 8px; }
                        .answer-table tr:nth-child(even) { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>${courseCode}: ${courseTitle}</h1>
                    <h2>Questions</h2>
                `;
                
                // Add each question without answers
                window.generatedQuestions.forEach((question, index) => {
                    html += `
                    <div class="question">
                        <h3>Q${index + 1}</h3>
                        <p>${question.text}</p>
                        <div class="metadata">
                            <p>Bloom Level: ${question.bloomLevel} | CO: ${question.courseOutcome} | Marks: ${question.marks}</p>
                        </div>
                    `;
                    
                    if (question.type === 'MCQ' && question.options && question.options.length > 0) {
                        html += '<div class="options">';
                        question.options.forEach(option => {
                            html += `<p>${option}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                });
                
                // Add answer key section with table format for compactness
                html += `
                    <div class="answer-key">
                        <h2>Answer Key</h2>
                        <table class="answer-table">
                            <tr>
                                <th>Question</th>
                                <th>Answer</th>
                            </tr>
                `;
                
                // Add all answers in a compact table format
                window.generatedQuestions.forEach((question, index) => {
                    html += `
                    <tr>
                        <td>Q${index + 1}</td>
                        <td>${question.correctAnswer}</td>
                    </tr>
                    `;
                });
                
                html += `
                        </table>
                    </div>
                </body>
                </html>
                `;
                
                // Create data URI and download as .docx
                const blob = new Blob([html], { type: 'application/vnd.ms-word' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${courseCode}_question_bank.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('Questions exported to Word successfully!', 'success');
            }
        });
    </script>
</body>
</html>